syntax = "proto3";

package loco.resource.v1;

import "google/protobuf/struct.proto";
import "google/protobuf/timestamp.proto";
import "google/protobuf/field_mask.proto";
import "google/protobuf/empty.proto";

import "deployment/v1/deployment.proto";
import "domain/v1/domain.proto";

option go_package = "github.com/team-loco/loco/shared/proto/resource/v1;resourcev1";

// ResourceType categorizes the type of resource being deployed.
enum ResourceType {
  RESOURCE_TYPE_UNSPECIFIED = 0;
  SERVICE  = 1;
  DATABASE = 2;
  FUNCTION = 3;
  CACHE    = 4;
  QUEUE    = 5;
  BLOB     = 6;
}

// ResourceStatus represents the operational status of a resource based on current deployment and health checks.
enum ResourceStatus {
  RESOURCE_STATUS_UNSPECIFIED = 0;
  HEALTHY     = 1;
  DEPLOYING   = 2;
  DEGRADED    = 3;
  UNAVAILABLE = 4;
  SUSPENDED   = 5;
}

// RegionIntentStatus represents the state of a region intent for a resource.
enum RegionIntentStatus {
  REGION_INTENT_STATUS_UNSPECIFIED = 0;
  REGION_INTENT_DESIRED      = 1;
  REGION_INTENT_PROVISIONING = 2;
  REGION_INTENT_ACTIVE       = 3;
  REGION_INTENT_DEGRADED     = 4;
  REGION_INTENT_REMOVING     = 5;
  REGION_INTENT_FAILED       = 6;
}

// ResourceService manages resource lifecycle and operations.
service ResourceService {
  // CreateResource creates a new resource.
  rpc CreateResource(CreateResourceRequest) returns (Resource);
  // GetResource retrieves a resource by ID or name.
  rpc GetResource(GetResourceRequest) returns (Resource);
  // UpdateResource updates a resource configuration.
  rpc UpdateResource(UpdateResourceRequest) returns (Resource);
  // DeleteResource deletes a resource.
  rpc DeleteResource(DeleteResourceRequest) returns (google.protobuf.Empty);

  // ListWorkspaceResources lists all resources in a workspace.
  rpc ListWorkspaceResources(ListWorkspaceResourcesRequest) returns (ListWorkspaceResourcesResponse);
  // GetResourceStatus retrieves the current status and deployment information of a resource.
  rpc GetResourceStatus(GetResourceStatusRequest) returns (GetResourceStatusResponse);
  // ListRegions lists available regions for resource deployment.
  rpc ListRegions(ListRegionsRequest) returns (ListRegionsResponse);

  // Logs
  // WatchLogs streams resource logs in real-time.
  rpc WatchLogs(WatchLogsRequest) returns (stream LogEntry);

  // Events
  // ListResourceEvents retrieves events for a resource.
  rpc ListResourceEvents(ListResourceEventsRequest) returns (ListResourceEventsResponse);

  // Resource Operations
  // ScaleResource adjusts resource replicas and resource allocation.
  rpc ScaleResource(ScaleResourceRequest) returns (google.protobuf.Empty);
  // UpdateResourceEnv updates environment variables for a resource.
  rpc UpdateResourceEnv(UpdateResourceEnvRequest) returns (google.protobuf.Empty);
}

// RoutingConfig defines routing configuration for a resource.
message RoutingConfig {
  int32  port         = 1; // application port
  string path_prefix  = 2; // e.g., "/"
  int32  idle_timeout = 3; // seconds
}

// LoggingConfig defines logging configuration.
message LoggingConfig {
  bool   enabled          = 1;
  string retention_period = 2; // e.g., "7d", "30d"
  bool   structured       = 3; // parse as JSON
}

// MetricsConfig defines metrics scraping configuration.
message MetricsConfig {
  bool   enabled = 1;
  string path    = 2; // e.g., "/metrics"
  int32  port    = 3; // e.g., 9090
}

// TracingConfig defines distributed tracing configuration.
message TracingConfig {
  bool                enabled     = 1;
  double              sample_rate = 2; // 0.0 to 1.0
  map<string, string> tags        = 3;
}

// ObservabilityConfig defines observability settings.
message ObservabilityConfig {
  LoggingConfig logging = 1;
  MetricsConfig metrics = 2;
  TracingConfig tracing = 3;
}

// RegionTarget defines the desired state for a specific region.
message RegionTarget {
  bool                                enabled      = 1;
  bool                                primary      = 2;
  string                              cpu          = 3; // e.g., "100m"
  string                              memory       = 4; // e.g., "256Mi"
  int32                               min_replicas = 5;
  int32                               max_replicas = 6;
  optional loco.deployment.v1.Scalers scalers      = 7; // autoscaling config
}

// ServiceSpec is the resource specification for SERVICE type resources.
message ServiceSpec {
  RoutingConfig                                 routing       = 1;
  ObservabilityConfig                           observability = 2;
  map<string, RegionTarget>                     regions       = 3; // key = region name
  optional loco.deployment.v1.HealthCheckConfig health_check  = 4; // health check defaults
}

// DatabaseSpec is a placeholder for DATABASE type resources (future implementation).
message DatabaseSpec {
  // reserved for future expansion
}

// CacheSpec is a placeholder for CACHE type resources (future implementation).
message CacheSpec {
  // reserved for future expansion
}

// QueueSpec is a placeholder for QUEUE type resources (future implementation).
message QueueSpec {
  // reserved for future expansion
}

// BlobSpec is a placeholder for BLOB type resources (future implementation).
message BlobSpec {
  // reserved for future expansion
}

// ResourceSpec defines the global infrastructure intent for a resource.
// Uses oneof to support different resource types.
message ResourceSpec {
  oneof spec {
    ServiceSpec  service  = 1;
    DatabaseSpec database = 2;
    CacheSpec    cache    = 3;
    QueueSpec    queue    = 4;
    BlobSpec     blob     = 5;
  }
}

// Resource represents a resource in a workspace.
message Resource {
  int64                                  id           = 1;
  int64                                  workspace_id = 2;
  string                                 name         = 3;
  ResourceType                           type         = 4;
  repeated loco.domain.v1.ResourceDomain domains      = 5;
  repeated RegionConfig                  regions      = 6;
  ResourceStatus                         status       = 7;
  optional ResourceSpec                  spec         = 8;
  int32                                  spec_version = 9;
  optional string                        description  = 10;
  int64                                  created_by   = 11;
  google.protobuf.Timestamp              created_at   = 12;
  google.protobuf.Timestamp              updated_at   = 13;
}

// RegionConfig represents a region deployment intent for a resource.
message RegionConfig {
  string             region     = 1;
  bool               is_primary = 2;
  RegionIntentStatus status     = 3;
  optional string    last_error = 4;
}

// --- CRUD ---

// CreateResourceRequest is the request to create a new resource.
message CreateResourceRequest {
  int64                      workspace_id = 1;
  string                     name         = 2;
  ResourceType               type         = 3;
  loco.domain.v1.DomainInput domain       = 4;
  ResourceSpec               spec         = 5;
  optional string            description  = 6;
}

// GetResourceRequest is the request to retrieve a resource.
message GetResourceRequest {
  optional int64  resource_id = 1;
  optional string name        = 2;
  optional int64  workspace_id = 3; // required if looking up by name
}

// ListWorkspaceResourcesRequest is the request to list resources.
message ListWorkspaceResourcesRequest {
  int64 workspace_id = 1;
  int32 limit        = 2;
  int32 offset       = 3;
}

// ListWorkspaceResourcesResponse is the response containing the list of resources.
message ListWorkspaceResourcesResponse {
  repeated Resource resources  = 1;
  int64             total_count = 2;
}

// UpdateResourceRequest is the request to update a resource.
message UpdateResourceRequest {
  int64                     resource_id = 1;
  google.protobuf.FieldMask update_mask = 2;
  optional string           name        = 3;
  optional string           description = 4;
}

// DeleteResourceRequest is the request to delete a resource.
message DeleteResourceRequest {
  int64 resource_id = 1;
}

// RegionInfo represents available region information.
message RegionInfo {
  string region        = 1;
  bool   is_default    = 2;
  string health_status = 3;
}

// ListRegionsRequest is the request to list available deployment regions.
message ListRegionsRequest {
}

// ListRegionsResponse is the response containing available regions.
message ListRegionsResponse {
  repeated RegionInfo regions = 1;
}

// GetResourceStatusRequest is the request to retrieve resource status.
message GetResourceStatusRequest {
  int64 resource_id = 1;
}

// DeploymentStatus represents the status of a resource deployment, including phase, replica count, and messages.
message DeploymentStatus {
  int64                              id       = 1;
  loco.deployment.v1.DeploymentPhase status   = 2;
  int32                              replicas = 3;
  optional string                    message  = 4;
}

// GetResourceStatusResponse is the response containing resource status information.
message GetResourceStatusResponse {
  Resource         resource           = 1;
  DeploymentStatus current_deployment = 2;
}

// --- Logs ---

// WatchLogsRequest is the request to stream resource logs.
message WatchLogsRequest {
  int64          resource_id = 1;
  optional int32 limit       = 2;
  optional bool  follow      = 3;
}

// LogEntry represents a single log line from a pod container within a resource.
message LogEntry {
  string                    pod_name  = 1;
  string                    namespace = 2;
  string                    container = 3;
  google.protobuf.Timestamp timestamp = 4;
  string                    log       = 5;
  string                    level     = 6;
}

// --- Events ---

// Event represents a Kubernetes event related to a resource (e.g., pod created, failed, crash loop).
message Event {
  google.protobuf.Timestamp timestamp = 1;
  string                    reason    = 2;
  string                    message   = 3;
  string                    type      = 4;
  string                    pod_name  = 5;
}

// ListResourceEventsRequest is the request to retrieve resource events.
message ListResourceEventsRequest {
  int64          resource_id = 1;
  optional int32 limit       = 2;
}

// ListResourceEventsResponse is the response containing resource events.
message ListResourceEventsResponse {
  repeated Event events = 1;
}

// --- Resource Operations ---

// ScaleResourceRequest is the request to scale a resource.
message ScaleResourceRequest {
  int64           resource_id = 1;
  optional int32  replicas    = 2;
  optional string cpu         = 3;
  optional string memory      = 4;
  optional string region      = 5; // if provided, scale only this region; otherwise scale all regions
}

// UpdateResourceEnvRequest is the request to update resource environment variables.
message UpdateResourceEnvRequest {
  int64               resource_id = 1;
  map<string, string> env         = 2;
  optional string     region      = 3; // if provided, update only this region; otherwise update all regions
}
