syntax = "proto3";

package loco.app.v1;

import "domain/v1/domain.proto";
import "google/protobuf/struct.proto";
import "google/protobuf/timestamp.proto";

option go_package = "github.com/loco-team/loco/shared/proto/app/v1;appv1";

enum AppType {
  SERVICE = 0;
  DATABASE = 1;
  FUNCTION = 2;
  CACHE = 3;
  QUEUE = 4;
  BLOB = 5;
}

enum DeploymentPhase {
  PENDING = 0;
  RUNNING = 1;
  SUCCEEDED = 2;
  FAILED = 3;
  CANCELED = 4;
}

enum AppStatus {
  AVAILABLE = 0;
  PROGRESSING = 1;
  DEGRADED = 2;
  UNAVAILABLE = 3;
  IDLE = 4;
}

// AppService manages application lifecycle and operations.
service AppService {
  // App CRUD
  // CreateApp creates a new application.
  rpc CreateApp(CreateAppRequest) returns (CreateAppResponse);
  // GetApp retrieves an application by ID.
  rpc GetApp(GetAppRequest) returns (GetAppResponse);
  // GetAppByName retrieves an application by name within a workspace.
  rpc GetAppByName(GetAppByNameRequest) returns (GetAppByNameResponse);
  // ListApps lists all applications in a workspace.
  rpc ListApps(ListAppsRequest) returns (ListAppsResponse);
  // UpdateApp updates an application configuration.
  rpc UpdateApp(UpdateAppRequest) returns (UpdateAppResponse);
  // DeleteApp deletes an application.
  rpc DeleteApp(DeleteAppRequest) returns (DeleteAppResponse);
  // GetAppStatus retrieves the current status and deployment information of an application.
  rpc GetAppStatus(GetAppStatusRequest) returns (GetAppStatusResponse);

  // Logs
  // StreamLogs streams application logs in real-time.
  rpc StreamLogs(StreamLogsRequest) returns (stream LogEntry);

  // Events
  // GetEvents retrieves events for an application.
  rpc GetEvents(GetEventsRequest) returns (GetEventsResponse);

  // App Operations
  // ScaleApp adjusts application replicas and resource allocation.
  rpc ScaleApp(ScaleAppRequest) returns (ScaleAppResponse);
  // UpdateAppEnv updates environment variables for an application.
  rpc UpdateAppEnv(UpdateAppEnvRequest) returns (UpdateAppEnvResponse);
}

// App represents an application in a workspace.
message App {
  int64 id = 1;
  int64 workspace_id = 2;
  string name = 4;
  string namespace = 5;
  AppType type = 6;
  repeated loco.domain.v1.AppDomain domains = 7;
  int64 created_by = 11;
  google.protobuf.Timestamp created_at = 12;
  google.protobuf.Timestamp updated_at = 13;
  AppStatus status = 14;
  optional google.protobuf.Struct spec = 15;
}

// --- CRUD ---

// CreateAppRequest is the request to create a new application.
message CreateAppRequest {
  int64 workspace_id = 1;
  string name = 3;
  AppType type = 4;
  loco.domain.v1.DomainInput domain = 5;
  optional google.protobuf.Struct spec = 6;
}

// CreateAppResponse is the response from creating an application.
message CreateAppResponse {
  App app = 1;
  string message = 2;
}

// GetAppRequest is the request to retrieve an application.
message GetAppRequest {
  int64 app_id = 1;
}

// GetAppResponse is the response containing application information.
message GetAppResponse {
  App app = 1;
}

// GetAppByNameRequest is the request to retrieve an application by name.
message GetAppByNameRequest {
  int64 workspace_id = 1;
  string name = 2;
}

// GetAppByNameResponse is the response containing the application.
message GetAppByNameResponse {
  App app = 1;
}

// ListAppsRequest is the request to list applications.
message ListAppsRequest {
  int64 workspace_id = 1;
}

// ListAppsResponse is the response containing the list of applications.
message ListAppsResponse {
  repeated App apps = 1;
}

// UpdateAppRequest is the request to update an application.
message UpdateAppRequest {
  int64 app_id = 1;
  optional string name = 2;
  optional string subdomain = 3;
  optional string domain = 4;
}

// UpdateAppResponse is the response from updating an application.
message UpdateAppResponse {
  App app = 1;
  string message = 2;
}

// DeleteAppRequest is the request to delete an application.
message DeleteAppRequest {
  int64 app_id = 1;
}

// DeleteAppResponse is the response from deleting an application.
message DeleteAppResponse {
  App app = 1;
  string message = 2;
}

// GetAppStatusRequest is the request to retrieve application status.
message GetAppStatusRequest {
  int64 app_id = 1;
}

// DeploymentStatus represents the status of an application deployment.
message DeploymentStatus {
  int64 id = 1;
  DeploymentPhase status = 2;
  int32 replicas = 3;
  optional string message = 4;
  optional string error_message = 5;
}

// GetAppStatusResponse is the response containing application status information.
message GetAppStatusResponse {
  App app = 1;
  DeploymentStatus current_deployment = 2;
}

// --- Logs ---

// StreamLogsRequest is the request to stream application logs.
message StreamLogsRequest {
  int64 app_id = 1;
  optional int32 limit = 2;
  optional bool follow = 3;
}

// LogEntry represents a single log line from an application.
message LogEntry {
  string pod_name = 1;
  string namespace = 2;
  string container = 3;
  google.protobuf.Timestamp timestamp = 4;
  string log = 5;
  string level = 6;
}

// --- Events ---

// Event represents an event related to an application.
message Event {
  google.protobuf.Timestamp timestamp = 1;
  string reason = 2;
  string message = 3;
  string type = 4;
  string pod_name = 5;
}

// GetEventsRequest is the request to retrieve application events.
message GetEventsRequest {
  int64 app_id = 1;
  optional int32 limit = 2;
}

// GetEventsResponse is the response containing application events.
message GetEventsResponse {
  repeated Event events = 1;
}

// --- App Operations ---

// ScaleAppRequest is the request to scale an application.
message ScaleAppRequest {
  int64 app_id = 1;
  optional int32 replicas = 2;
  optional string cpu = 3;
  optional string memory = 4;
}

// ScaleAppResponse is the response from scaling an application.
message ScaleAppResponse {
  DeploymentStatus deployment = 1;
}

// UpdateAppEnvRequest is the request to update application environment variables.
message UpdateAppEnvRequest {
  int64 app_id = 1;
  map<string, string> env = 2;
}

// UpdateAppEnvResponse is the response from updating environment variables.
message UpdateAppEnvResponse {
  DeploymentStatus deployment = 1;
}
