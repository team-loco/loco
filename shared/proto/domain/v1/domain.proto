syntax = "proto3";

package loco.domain.v1;

import "google/protobuf/empty.proto";
import "google/protobuf/field_mask.proto";
import "google/protobuf/timestamp.proto";

option go_package = "github.com/team-loco/loco/shared/proto/domain/v1;domainv1";

// DomainType indicates the source of a domain: platform-provided or user-provided.
enum DomainType {
  DOMAIN_TYPE_UNSPECIFIED = 0;
  PLATFORM_PROVIDED = 1;
  USER_PROVIDED     = 2;
}

// --- Messages ---

// PlatformDomain represents a platform-provided domain.
message PlatformDomain {
  int64                     id         = 1;
  string                    domain     = 2;
  bool                      is_active  = 3;
  google.protobuf.Timestamp created_at = 4;
  google.protobuf.Timestamp updated_at = 5;
}

// DomainInput specifies domain configuration for a resource.
message DomainInput {
  DomainType      domain_source      = 1;
  optional string subdomain          = 2; // for PLATFORM_PROVIDED: "myapp"
  optional int64  platform_domain_id = 3; // for PLATFORM_PROVIDED: id of the platform domain
  optional string domain             = 4; // for USER_PROVIDED: full custom domain
}

// ResourceDomain represents a domain assigned to a resource.
message ResourceDomain {
  int64                     id                 = 1;
  int64                     resource_id        = 2;
  string                    domain             = 3;
  DomainType                domain_source      = 4;
  optional string           subdomain_label    = 5;
  optional int64            platform_domain_id = 6;
  bool                      is_primary         = 7;
  google.protobuf.Timestamp created_at         = 8;
  google.protobuf.Timestamp updated_at         = 9;
}

// --- Service ---

// DomainService manages domains for resources.
service DomainService {
  // Platform Domain CRUD
  // CreatePlatformDomain creates a new platform-provided domain.
  rpc CreatePlatformDomain(CreatePlatformDomainRequest) returns (PlatformDomain);
  // GetPlatformDomain retrieves a platform domain by ID or name.
  rpc GetPlatformDomain(GetPlatformDomainRequest) returns (PlatformDomain);
  // ListPlatformDomains lists platform domains with optional filters.
  rpc ListPlatformDomains(ListPlatformDomainsRequest) returns (ListPlatformDomainsResponse);
  // UpdatePlatformDomain updates a platform domain.
  rpc UpdatePlatformDomain(UpdatePlatformDomainRequest) returns (PlatformDomain);
  // DeletePlatformDomain deletes a platform domain.
  rpc DeletePlatformDomain(DeletePlatformDomainRequest) returns (google.protobuf.Empty);

  // Resource Domain Management
  // CreateResourceDomain assigns a domain to a resource.
  rpc CreateResourceDomain(CreateResourceDomainRequest) returns (ResourceDomain);
  // UpdateResourceDomain updates a resource's domain configuration.
  rpc UpdateResourceDomain(UpdateResourceDomainRequest) returns (ResourceDomain);
  // SetPrimaryResourceDomain sets the primary domain for a resource.
  rpc SetPrimaryResourceDomain(SetPrimaryResourceDomainRequest) returns (ResourceDomain);
  // DeleteResourceDomain removes a domain from a resource.
  rpc DeleteResourceDomain(DeleteResourceDomainRequest) returns (google.protobuf.Empty);

  // Queries
  // ListLocoOwnedDomains lists all domains owned by Loco with resources.
  rpc ListLocoOwnedDomains(ListLocoOwnedDomainsRequest) returns (ListLocoOwnedDomainsResponse);
  // CheckDomainAvailability checks if a domain is available.
  rpc CheckDomainAvailability(CheckDomainAvailabilityRequest) returns (CheckDomainAvailabilityResponse);
  }

// --- Platform Domain Requests/Responses ---

// CreatePlatformDomainRequest is the request to create a platform domain.
message CreatePlatformDomainRequest {
  string domain    = 1;
  bool   is_active = 2;
}

// GetPlatformDomainRequest is the request to retrieve a platform domain.
message GetPlatformDomainRequest {
  optional int64  id     = 1;
  optional string domain = 2;
}

// ListPlatformDomainsRequest is the request to list platform domains.
message ListPlatformDomainsRequest {
  optional bool active_only = 1;
  int32         limit       = 2;
  int32         offset      = 3;
}

// ListPlatformDomainsResponse contains the list of platform domains.
message ListPlatformDomainsResponse {
  repeated PlatformDomain platform_domains = 1;
  int64                   total_count      = 2;
}

// UpdatePlatformDomainRequest is the request to update a platform domain.
message UpdatePlatformDomainRequest {
  int64                     id          = 1;
  google.protobuf.FieldMask update_mask = 2;
  optional string           domain      = 3;
  optional bool             is_active   = 4;
}

// DeletePlatformDomainRequest is the request to delete a platform domain.
message DeletePlatformDomainRequest {
  int64 id = 1;
}

// --- List Loco Owned Domains ---

// LocoOwnedDomain represents a platform-managed domain paired with a resource deployment.
message LocoOwnedDomain {
  int64  id              = 1;
  string domain          = 2;
  string resource_name   = 3;
  int64  resource_id     = 4;
  string platform_domain = 5;
}

// ListLocoOwnedDomainsRequest is the request to list all Loco-owned domains.
message ListLocoOwnedDomainsRequest {}

// ListLocoOwnedDomainsResponse contains the list of Loco-owned domains.
message ListLocoOwnedDomainsResponse {
  repeated LocoOwnedDomain domains = 1;
}

// --- Resource Domain Management ---

// CreateResourceDomainRequest is the request to add a domain to a resource.
message CreateResourceDomainRequest {
  int64       resource_id = 1;
  DomainInput domain      = 2;
}

// UpdateResourceDomainRequest is the request to update a resource's domain.
message UpdateResourceDomainRequest {
  int64                     domain_id   = 1;
  google.protobuf.FieldMask update_mask = 2;
  optional string           domain      = 3;
}

// SetPrimaryResourceDomainRequest is the request to set the primary domain for a resource.
message SetPrimaryResourceDomainRequest {
  int64 resource_id = 1;
  int64 domain_id   = 2;
}

// DeleteResourceDomainRequest is the request to remove a domain from a resource.
message DeleteResourceDomainRequest {
   int64 domain_id = 1;
}

// --- Domain Availability ---

// CheckDomainAvailabilityRequest is the request to check if a domain is available.
message CheckDomainAvailabilityRequest {
   string domain = 1;
}

// CheckDomainAvailabilityResponse contains the availability check result.
message CheckDomainAvailabilityResponse {
   bool is_available = 1;
}
