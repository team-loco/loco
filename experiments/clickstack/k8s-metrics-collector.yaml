---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: k8s-metrics-collector
  namespace: otel-demo
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: k8s-metrics-collector
rules:
  - apiGroups: [""]
    resources:
      - nodes/proxy
      - nodes/stats
      - endpoints
      - services
      - pods
    verbs: ["get", "watch", "list"]
  - apiGroups: ["apps"]
    resources:
      - replicasets
      - deployments
    verbs: ["get", "watch", "list"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: k8s-metrics-collector
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: k8s-metrics-collector
subjects:
  - kind: ServiceAccount
    name: k8s-metrics-collector
    namespace: otel-demo
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: k8s-metrics-collector-config
  namespace: otel-demo
data:
  config.yaml: |
    receivers:
      kubeletstats:
        collection_interval: 20s
        auth_type: "serviceAccount"
        endpoint: "https://${env:K8S_NODE_NAME}:10250"
        insecure_skip_verify: true
        node: "${env:K8S_NODE_NAME}"
        k8s_api_config:
          auth_type: serviceAccount
        metric_groups:
          - node
          - pod
          - container
        metrics:
          k8s.pod.cpu_limit_utilization:
            enabled: true
          k8s.pod.cpu_request_utilization:
            enabled: true
          k8s.pod.memory_limit_utilization:
            enabled: true
          k8s.pod.memory_request_utilization:
            enabled: true
          k8s.pod.uptime:
            enabled: true
          k8s.node.uptime:
            enabled: true
          k8s.container.cpu_limit_utilization:
            enabled: true
          k8s.container.cpu_request_utilization:
            enabled: true
          k8s.container.memory_limit_utilization:
            enabled: true
          k8s.container.memory_request_utilization:
            enabled: true
          container.uptime:
            enabled: true
          k8s.node.network.io:
            enabled: true
          k8s.pod.network.io:
            enabled: true

    processors:
      batch:
        timeout: 1s
        send_batch_size: 100
      memory_limiter:
        check_interval: 1s
        limit_mib: 512
      k8sattributes:
        auth_type: "serviceAccount"
        passthrough: false
        extract:
          metadata:
            - k8s.pod.name
            - k8s.pod.uid
            - k8s.deployment.name
            - k8s.namespace.name
            - k8s.node.name
            - k8s.pod.start_time
          labels:
            - tag_name: app.kubernetes.io/name
              key: app.kubernetes.io/name
              from: pod
          annotations:
            - tag_name: app.kubernetes.io/version
              key: app.kubernetes.io/version
              from: pod

    exporters:
      otlp:
        endpoint: clickstack-otel-collector:4317
        tls:
          insecure: true
        headers:
          authorization: "${env:HYPERDX_API_KEY}"
      debug:
        verbosity: basic

    service:
      pipelines:
        metrics:
          receivers: [kubeletstats]
          processors: [k8sattributes, batch, memory_limiter]
          exporters: [otlp, debug]
---
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: k8s-metrics-collector
  namespace: otel-demo
spec:
  selector:
    matchLabels:
      app: k8s-metrics-collector
  template:
    metadata:
      labels:
        app: k8s-metrics-collector
    spec:
      serviceAccountName: k8s-metrics-collector
      hostNetwork: true
      dnsPolicy: ClusterFirstWithHostNet
      containers:
      - name: otelcol
        image: otel/opentelemetry-collector-contrib:0.142.0
        args:
          - "--config=/etc/otelcol/config.yaml"
        env:
        - name: K8S_NODE_NAME
          valueFrom:
            fieldRef:
              fieldPath: spec.nodeName
        - name: K8S_POD_NAME
          valueFrom:
            fieldRef:
              fieldPath: metadata.name
        - name: K8S_POD_NAMESPACE
          valueFrom:
            fieldRef:
              fieldPath: metadata.namespace
        - name: HYPERDX_API_KEY
          valueFrom:
            secretKeyRef:
              name: hyperdx-secret
              key: HYPERDX_API_KEY
              optional: true
        volumeMounts:
        - name: config
          mountPath: /etc/otelcol
        resources:
          limits:
            cpu: 250m
            memory: 512Mi
          requests:
            cpu: 100m
            memory: 256Mi
      volumes:
      - name: config
        configMap:
          name: k8s-metrics-collector-config
