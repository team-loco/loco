name: Deploy and Update Infra

on:
  push:
    branches:
      - main

env:
  TF_TOKEN_app_terraform_io: ${{ secrets.TF_API_TOKEN }}
  DIGITALOCEAN_TOKEN: ${{ secrets.DIGITALOCEAN_PAT }}

  REGISTRY: ghcr.io
  API_IMAGE_NAME: ${{ github.repository }}
  CONTROLLER_IMAGE_NAME: ${{ github.repository }}-controller
jobs:
  infra:
    name: Provision Infrastructure
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3

      - name: Terraform Init
        run: cd terraform && terraform init

      - name: Terraform Plan
        run: cd terraform && terraform plan -out=tfplan

      - name: Terraform Apply
        run: cd terraform && terraform apply -auto-approve "tfplan"

  push-controller-image:
    name: Build and Push Controller Image
    uses: ./.github/workflows/build-push.yml
    permissions:
      contents: read
      packages: write
    with:
      image_name: ${{ github.repository }}-controller
      context: ./controller
      dockerfile: ./controller/Dockerfile

  push-api-image:
    name: Build and Push API Image
    uses: ./.github/workflows/build-push.yml
    permissions:
      contents: read
      packages: write
    with:
      image_name: ${{ github.repository }}-api
      context: .
      dockerfile: ./api/Dockerfile

  deploy:
    name: Deploy Helm Charts
    runs-on: ubuntu-latest
    needs:
      - infra
      - push-api-image
      - push-controller-image
    environment: production

    env:
      # ---- secrets consumed by helmfile via requiredEnv ----
      CLOUDFLARE_TOKEN: ${{ secrets.CLOUDFLARE_TOKEN }}

      GITLAB_PAT: ${{ secrets.GITLAB_PAT }}
      GITLAB_PROJECT_ID: ${{ secrets.GITLAB_PROJECT_ID }}
      GITLAB_TOKEN_NAME: ${{ secrets.GITLAB_TOKEN_NAME }}
      GITLAB_URL: ${{ secrets.GITLAB_URL }}
      GITLAB_REGISTRY_URL: ${{ secrets.GITLAB_REGISTRY_URL }}
      GITLAB_DEPLOY_TOKEN_NAME: ${{ secrets.GITLAB_DEPLOY_TOKEN_NAME }}

      GH_OAUTH_CLIENT_ID: ${{ secrets.GH_OAUTH_CLIENT_ID }}
      GH_OAUTH_CLIENT_SECRET: ${{ secrets.GH_OAUTH_CLIENT_SECRET }}
      GH_OAUTH_REDIRECT_URL: ${{ secrets.GH_OAUTH_REDIRECT_URL }}
      GH_OAUTH_STATE: ${{ secrets.GH_OAUTH_STATE }}

      APP_ENV: ${{ secrets.APP_ENV }}
      LOG_LEVEL: ${{ secrets.LOG_LEVEL }}
      PORT: ${{ secrets.PORT }}
      DATABASE_URL: ${{ secrets.DATABASE_URL }}
      JWT_SECRET: ${{ secrets.JWT_SECRET }}

      REGISTRY_TAG: ghcr.io/${{ github.repository }}:sha-${{ github.sha }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install doctl
        uses: digitalocean/action-doctl@v2
        with:
          token: ${{ secrets.DIGITALOCEAN_PAT }}

      - name: Get kubeconfig
        run: doctl kubernetes cluster kubeconfig save loco-cluster

      - name: Verify cluster access
        run: kubectl get nodes

      - name: Wait for nodes to be ready
        run: kubectl wait --for=condition=Ready node --all --timeout=180s

      - name: Setup Helm
        uses: azure/setup-helm@v4.3.0

      - name: Deploy with Helmfile
        uses: helmfile/helmfile-action@v2.0.4
        with:
          helmfile-args: sync --environment prod
